# 情绪分析算法文档

## 概述

MoodPulse 采用多层次情绪分析算法，结合双引擎情绪检测、时序分析和心理学模型，为用户提供准确的情绪评估和专注时长统计。

## 核心算法

### 1. 情绪指数算法 (Emotion Index)

**目标**: 将用户的情绪状态量化为1-10分的情绪指数

**算法流程**:

#### 1.1 多模态置信度融合

使用FER和DeepFace双引擎检测，按置信度加权融合：

```
融合分数 = (FER分数 × FER置信度 + DeepFace分数 × DeepFace置信度) / (FER置信度 + DeepFace置信度)
```

**一致性加成**: 当两个引擎预测结果一致时，额外增加0.5分

#### 1.2 情绪映射表

| 情绪类别 | 分数 | 说明 |
|---------|------|------|
| happy   | 10.0 | 开心、愉悦 |
| calm    | 7.0  | 平静、放松 |
| neutral | 5.0  | 中性 |
| tired   | 4.0  | 疲惫 |
| worried | 3.0  | 担心、焦虑 |
| sad     | 2.0  | 悲伤 |
| angry   | 1.0  | 愤怒 |

#### 1.3 加权时序衰减

对历史记录应用指数衰减，越近的记录权重越高：

```
时间权重 = exp(-0.1 × (n - i - 1))
综合权重 = 时间权重 × 置信度
```

其中：
- n: 总记录数
- i: 当前记录索引
- 衰减率: 0.1

#### 1.4 峰终定律 (Peak-End Rule)

基于心理学研究，人们对体验的记忆主要由峰值和终值决定：

```
情绪指数 = 0.6 × 加权平均 + 0.2 × 峰值情绪 + 0.2 × 最终情绪
```

**最终输出**: 1.0 - 10.0 之间的浮点数，保留2位小数

---

### 2. 压力水平算法 (Stress Level)

**目标**: 评估用户的压力状态，输出0-100的压力百分比

**算法模型**: 情绪波动惩罚模型

#### 2.1 基础指标计算

1. **平均情绪分数**: 所有有效记录的加权平均
2. **标准差**: 衡量情绪波动程度
3. **负面情绪占比**: 分数<5的记录比例

#### 2.2 压力成分

**成分1: 情绪低落因子 (0-40分)**
```
情绪低落压力 = ((10 - 平均分数) / 9) × 40
```

**成分2: 波动性因子 (0-30分)**
```
波动性压力 = (标准差 / 3) × 30
```
- 标准差越大，情绪波动越剧烈，压力越高

**成分3: 负面情绪占比因子 (0-30分)**
```
负面压力 = 负面情绪占比 × 30
```

#### 2.3 综合压力水平

```
总压力 = 情绪低落压力 + 波动性压力 + 负面压力
```

**压力等级划分**:

| 压力范围 | 等级 | 颜色 | 说明 |
|---------|------|------|------|
| 0-25%   | 低压力 | 绿色 | 状态良好 ✅ |
| 25-50%  | 轻度压力 | 琥珀色 | 需要注意 ⚠️ |
| 50-75%  | 中度压力 | 橙色 | 建议休息 ⚠️⚠️ |
| 75-100% | 高压力 | 红色 | 需要干预 🚨 |

---

### 3. 专注时长分析算法 (Focus Time Analysis)

**目标**: 识别用户的专注时段，统计专注次数和时长

#### 3.1 专注状态定义

**专注条件**:
- `has_face = 1` (检测到人脸)
- `is_away = 0` (未离开工位)

#### 3.2 专注时段识别

**算法逻辑**:

1. 按时间戳排序所有记录
2. 遍历记录，识别连续的专注状态
3. 如果两条专注记录间隔 > 60秒，视为新的专注时段
4. 记录每个专注时段的起止时间

**伪代码**:
```
for each record in sorted_records:
    if is_focusing(record):
        if session_start exists:
            if gap > 60 seconds:
                save current session
                start new session
        else:
            start new session
    else:
        if session_start exists:
            save current session
```

#### 3.3 专注次数统计

**有效专注定义**: 持续时间 ≥ 30分钟

```
专注次数 = count(专注时段 where 持续时长 >= 30分钟)
```

#### 3.4 当前专注状态判断

**判断逻辑**:
1. 检查最后一条记录是否为专注状态
2. 如果是，计算从专注开始到最后一条记录的时长
3. 返回当前专注时长（分钟）

**输出数据**:
```typescript
{
  total_focus_sessions: number,    // 今日专注次数
  current_focus_duration: number,  // 当前专注时长（分钟）
  is_currently_focusing: boolean,  // 是否正在专注
  total_focus_time: number         // 今日总专注时长（分钟）
}
```

---

### 4. 情绪时间线算法 (Emotion Timeline)

**目标**: 生成30分钟间隔的情绪变化曲线

#### 4.1 时间分组

将今日所有有效记录按30分钟间隔分组：

```
时间间隔 = {
  8:00, 8:30, 9:00, 9:30, 10:00, ...
}
```

**分组规则**:
- 0-29分钟 → :00
- 30-59分钟 → :30

#### 4.2 间隔内情绪聚合

对每个30分钟间隔：
1. 收集该时段内所有记录的情绪分数
2. 计算平均分数
3. 转换为0-1范围的情绪值

```
情绪值 = 平均分数 / 10.0
```

#### 4.3 情绪标签映射

根据平均分数分配表情��标签：

| 分数范围 | 表情 | 标签 |
|---------|------|------|
| ≥ 8.0   | 😊   | happy |
| 6.0-8.0 | 😌   | calm |
| 4.0-6.0 | 😴   | tired |
| < 4.0   | 😟   | worried |

#### 4.4 数据平滑处理

**缺失数据处理**: 只显示有数据的时间点，前端自动连接形成平滑曲线

**输出格式**:
```typescript
{
  time: "8:00",
  value: 0.72,
  emoji: "😌",
  emotion: "calm"
}
```

---

## 数据采集

### 采集频率
- **情绪检测**: 每5秒一次
- **数据存储**: 每次检测结果实时存储到SQLite数据库
- **分析刷新**: 前端每30秒自动刷新分析结果

### 数据有效性过滤

**有效记录条件**:
- `has_face = 1` (检测到人脸)
- `is_away = 0` (未离开工位)

**无效记录**: 不参与情绪指数和压力水平计算，但保留在数据库中

---

## 算法参数

### 可调参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 时序衰减率 | 0.1 | 控制历史记录权重衰减速度 |
| 峰终权重 | 0.6/0.2/0.2 | 加权平均/峰值/终值的权重分配 |
| 专注间隔阈值 | 60秒 | 判断专注时段分割的最大间隔 |
| 最小专注时长 | 30分钟 | 计入专注次数的最小持续时间 |
| 时间线间隔 | 30分钟 | 情绪曲线的时间粒度 |

### 性能优化

1. **数据库索引**: 在`datetime`和`timestamp`字段建立索引
2. **批量查询**: 一次性获取今日所有数据，避免多次查询
3. **内存缓存**: 前端缓存分析结果，减少重复计算
4. **增量更新**: 只在新数据到达时重新计算

---

## 算法验证

### 测试数据

使用模拟数据生成器 (`generate_mock_data_auto.py`) 生成符合真实场景的测试数据：

- **时间范围**: 8:00-13:40
- **记录数**: 4081条
- **情绪分布**: 模拟办公室工作者的情绪变化模式

### 预期结果

**情绪指数**: 6.0-8.0（因为happy和calm占比高）
**压力水平**: 25-45%（轻度压力）
**专注次数**: 2-3次（上午和下午各有专注时段）

---

## 心理学依据

### 峰终定律 (Peak-End Rule)

**理论来源**: Daniel Kahneman的行为经济学研究

**核心观点**: 人们对体验的记忆主要由两个因素决定：
1. 体验的峰值（最强烈的时刻）
2. 体验的终值（结束时的感受）

**应用**: 情绪指数算法中，峰值和终值各占20%权重

### 情绪波动与压力

**理论依据**: 情绪稳定性是心理健康的重要指标

**应用**: 压力算法中，标准差（波动性）占30%权重

---

## 未来改进方向

1. **个性化基线**: 为每个用户建立情绪基线，提供相对评估
2. **时段分析**: 识别用户的情绪高峰和低谷时段
3. **趋势预测**: 基于历史数据预测未来情绪走向
4. **异常检测**: 识别异常的情绪波动，及时提醒
5. **多维度分析**: 结合工作效率、休息频率等多维度数据

---

## 参考文献

1. Kahneman, D. (2011). *Thinking, Fast and Slow*. Farrar, Straus and Giroux.
2. Russell, J. A. (1980). A circumplex model of affect. *Journal of Personality and Social Psychology*, 39(6), 1161-1178.
3. Ekman, P. (1992). An argument for basic emotions. *Cognition & Emotion*, 6(3-4), 169-200.

---

**文档版本**: 1.0
**最后更新**: 2025-12-28
**维护者**: MoodPulse Team
